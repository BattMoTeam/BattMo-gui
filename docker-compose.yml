version: "3.3"

services:
  liiondb_api:
    build: ./liiondb_api
    container_name: liiondb_api
    restart: always
    ports:
      - "5000:5000"
    # volumes:
    #   - ./liiondb_api:/app
    command: python wsgi.py

  battmo_jl_api:
    build: ./battmo_jl_api
    container_name: battmo_jl_api
    restart: always
    ports:
      - "8000:8000"
    volumes:
      - ./battmo_jl_api:/home/genie/app
    #command: gunicorn -w 1 -b 0.0.0.0:8000 wsgi:server --timeout 200
    command: julia --project=. -e 'include("app/rest.jl")' --color=yes --depwarn=no --project=@. --sysimage="/home/sysimage.so" -q -i -- $$(dirname $$0)/../bootstrap.jl -s=true "$$@"
    # --color=yes --depwarn=no --project=@. --sysimage=/usr/local/julia/lib/julia/sys.so -q -i -- $(dirname $0)/../bootstrap.jl -s=true "$@"

  nginx:
    build: ./nginx
    container_name: nginx
    restart: always
    ports:
      - "8001:8001"
      - "8002:8002"
    volumes:
      - ./nginx:/app

    depends_on:
      - battmo_jl_api
      - battmo_gui

  battmo_gui:
    build: ./battmo_gui
    container_name: battmo_gui
    restart: always
    ports:
      - "8501:8501"
    volumes:
      - ./battmo_gui:/app
    depends_on:
      - battmo_jl_api

    command: streamlit run Introduction.py --global.disableWidgetStateDuplicationWarning true --server.port=8501